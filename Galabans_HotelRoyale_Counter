<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, June 01, 2015, 3:47 PM -->
<!-- MuClient version 4.98 -->

<!-- Plugin "Galabans_HotelRoyale_Counter" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Galabans_HotelRoyale_Counter"
   author="Galaban"
   id="b41d560645659e4fceff6f24"
   language="Lua"
   purpose="Keep track of the current state of the Hotel Royale casino"
   save_state="y"
   date_written="2015-06-01 15:44:56"
   requires="4.98"
   version="1.0"
   >
<description trim="y">
<![CDATA[
Galaban's Hotel Royale Counter

This plugin will help you know how close you get to winning the Share of the Hotel Royale when you gamble at the Hotel Royale on Prosper's Island

]]>
</description>

</plugin>


<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   group="CasinoRoyale"
   match="The roulette croupier exclaims &quot;Galaban wins!&quot;"
   name="trgRoyale1"
   send_to="12"
   sequence="100"
  >
  <send>
    incrementCorrect()
</send>
  </trigger>
  <trigger
   enabled="y"
   group="CasinoRoyale"
   match="The ball stops ..... on a wrong number...."
   name="trgRoyale2"
   send_to="12"
   sequence="100"
  >
  <send>
    incrementWrong()
  </send>
  </trigger>

  <trigger
   enabled="y"
   group="CasinoRoyale"
   match="The roulette croupier gives a pile of gold coins to chip seller."
   omit_from_output="y"
   name="trgRoyale3"
   send_to="12"
   sequence="100"
  >
  <send>
	local c_dyellow = ANSI(22)..ANSI(33)
    local c_grey = ANSI(22)..ANSI(37)
    AnsiNote(c_dyellow.."The roulette croupier gives a pile of gold coins to chip seller. "..c_grey.."(counter reset)")
    resetCounter()
  </send>
  </trigger>
</triggers>

<!--  Variables  -->

<variables>
  <variable name="vRoyaleCounter">0</variable>
</variables>

<!--  Script  -->


<script>
<![CDATA[

require "gmcphelper"
require "wait"

function OnPluginBroadcast (msg, id, name, text)
   if id == "3e7dedbe37e44942dd46d264" then -- gmcphandler
      if performing_maintenance == true then
         queue_broadcast(msg, id, name, text)
         return
      end

      if (text == "room.info") then
         blinded = false
         res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","room.info")
         luastmt = "gmcpdata = " .. gmcparg
         assert (loadstring (luastmt or "")) ()

         got_gmcp_room()
      end 

   end --if gmcphandler
end

last_id = -1
function got_gmcp_room()
    local room_id = tonumber(gmcpval("num"))

    --@RLA --- get correct room number
    if (room_id == 28334) then
        greet()
        if (last_id ~= room_id) then
            resetCounter()
        end
    end

    last_id = room_id

end

function greet()
    local c_cyan = ANSI(1)..ANSI(36)

    wait.make (function()
        local c_grey = ANSI(22)..ANSI(37)
        local c_green = ANSI(1)..ANSI(32)

        wait.time(0.2)

        AnsiNote("")
        AnsiNote(c_cyan.."Galaban says 'Welcome to the Hotel Royale Casino.'")
        AnsiNote(c_cyan.."Galaban says 'Here, you have an opportunity to win a Share of the Hotel Royale'")
        AnsiNote(c_cyan.."Galaban says 'Just buy a chip and give it to the croupier.'")
        AnsiNote(c_cyan.."Galaban says 'I will keep count for you.  "..c_green.."If you get to positive 6, you will win"..c_cyan..".'")
        AnsiNote(c_cyan.."Galaban says 'If the dealer wins too often, they will transfer some of their money.'")
        AnsiNote(c_cyan.."Galaban says 'This will reset the counter, along with your odds of winning.'")
        AnsiNote("")

    end)

end

function incrementWrong()
    local val = GetVariable("vRoyaleCounter")
    
    if (val == nil) then
        val = "0"
    end
    local ival = tonumber(val) - 1
    
    SetVariable("vRoyaleCounter", ival)
    outputCounter()
end

function incrementCorrect()
    local val = GetVariable("vRoyaleCounter")
    
    if (val == nil) then
        val = "0"
    end
    local ival = tonumber(val) + 1
    
    SetVariable("vRoyaleCounter", ival)
    outputCounter()
end

function resetCounter()
    SetVariable("vRoyaleCounter","0")
end

function outputCounter()
    local c_red = ANSI(1)..ANSI(31)
    local c_white = ANSI(1)..ANSI(37)
    local c_green = ANSI(1)..ANSI(32)

    local val = tonumber(GetVariable("vRoyaleCounter"))

    local statusColor = c_white
    if (val < -2) then
        statusColor = c_red
    elseif (val > 2) then
        statusColor = c_green
    end

    AnsiNote(statusColor.."Counter: "..val.." of 6")
end


]]>
</script>


<!--  Plugin help  -->

<aliases>
  <alias
   script="OnHelp"
   match="Galabans_HotelRoyale_Counter:help"
   enabled="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[
function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
end
]]>
</script> 

</muclient>
